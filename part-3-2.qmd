# County Housing Market Assessment

The following provides a county-level analysis of major trends impacting housing within Central Virginia Planning District region. All data has been disaggregated to show the differences between localities.

```{r}
#| label: setup

library(tidyverse)
library(tigris)
library(hdatools)
library(ggiraph)
library(scales)
library(ggtext)
library(tidytext)
library(janitor)
library(sf)

cnty <- c("51009", "51011", "51019", "51031", "51515") # County FIPS codes

cv_names <- list_counties("VA") |> 
  mutate(GEOID = paste0("51", county_code))

cnty_code <- c("009", "011", "019", "031", "515")

```

## Takeaways

- Domestic migration is driving population growth in the counties --- especially in Bedford.
- Amherst's population is expected to continue its decline for the next several decades.
- Older homeowners are driving much of the growth, while renters are mainly coming to Campbell more and more.
- Income disparities vary by county and racial and ethnic identity, but renter incomes lag behind homeowners regardless.
- Diverse housing is lacking in the counties, especially among the homeowner housing stock.
- Development activity in Amherst and Appomattox has been limited, while Bedford has seen declines in recent years and Campbell has seen increases.
- Homeownership rates have been declining in recent years, except for in Bedford.
- Rents have been relatively flat despite the demand.
- Assisted housing is limited in the counties and cost burden for renters has remained relatively unchanged in the last decade.

## Population trends

From 2010 to 2020, Bedford County has grown more than any other locality in the region, experiencing a 16 percent increase. In fact, as of the 2020 Census, Bedford County (is more populous than the City of Lynchburg (79,462 versus 79,009, respectively).

Appomattox and Campbell experienced slight to moderate growth in the last decade, while Amherst County's population declined by three percent.

```{r}
#| label: fig-localpop
#| fig-cap: "Total population by county"

# Read in population data and filter for only the counties using the county list.

pop_data <- read_rds("data/pop_data.rds") |> 
  subset(GEOID %in% cnty)

# Join the data to the names list and clean.

local_pop <- pop_data |> 
  left_join(cv_names, by = "GEOID") |> 
  select(GEOID, year, county, counttype, value) |> 
  group_by(county) |> 
  mutate(pchg = (value - first(value))/first(value)) |> 
  filter(year == 2020) |> 
  select(GEOID, county, value, pchg)

local_pop_plot <- ggplot(local_pop,
       aes(x = reorder(county, -value),
           y = value,
           fill = county,
           data_id = value,
           tooltip = label_number(big.mark = ",")(value))) +
  geom_col() +
  geom_col_interactive() +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  labs(title = "Total population by county",
       subtitle = "2020 Census population",
       caption = "**Source:** U.S. Census Bureau, Decennial Census.") +
  scale_y_continuous(labels = label_comma(), limits = c(0, 100000))

publish_plot(local_pop_plot)

```

```{r}
#| label: fig-local-pchg
#| fig-cap: "Population growth by county"

local_growth_plot <- ggplot(local_pop,
       aes(x = reorder(county, -pchg),
           y = pchg,
           fill = county,
           data_id = pchg,
           tooltip = label_percent()(pchg))) +
  geom_col() +
  geom_col_interactive() +
  theme_hfv() +
  add_zero_line("y") + +
  scale_fill_hfv() +
  scale_y_continuous(labels = label_percent(), limits = c(-.05, .2)) +
  labs(title = "Population growth by county",
       subtitle = "Percent change in population from 2010",
       caption = "**Source:** U.S. Census Bureau, Population Estimates Program.")

publish_plot(local_growth_plot)

```

Population growth in Bedford and Appomattox can be largely attributed to domestic migration. In Bedford specifically, there has been significant losses in population due to natural decreases, but domestic migration has outpaced those decreases to lead to a net increase in population.

The loss of population in Amherst County has largely been a result of domestic out migration over the decade, but also natural decreases. It was not until recently that Amherst began to see some growth again.

Campbell County's population changes have been driven by international migration into the county for much of the last decade. And in 2021, domestic migration began to contribute towards growth whereas the county was previously seeing migration out of the county to other parts of the region, state, or nation.

```{r}
#| label: fig-local-chg
#| fig-cap: "Components of population change by county"

local_change <- read_rds("data/comp_data.rds") |> 
  filter(NAMELSAD != "Lynchburg city")

# Create group bar chart showing population change by locality.

local_change_plot <- ggplot(local_change,
       aes(x = year, 
           y = value,
           fill = component,
           data_id = value,
           tooltip = label_number(big.mark = ",", style_negative = "minus", style_positive = "plus")(value))) +
  geom_col(position = "stack") +
  geom_col_interactive() +
  facet_wrap(~NAMELSAD, nrow = 1) +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  scale_y_continuous(labels = label_number(big.mark = ",", style_positive = "plus", style_negative = "minus")) +
  theme(axis.text.x = element_text(size = 6, angle = 90),
        legend.position = "bottom") +
  labs(title = "Components of population change by county",
       subtitle = "Net domestic migration, international migration, and natural increase (or decrease)",
       caption = "**Source:** U.S. Census Bureau, Population Estimates Program.<br>**Note:** Natural increase (or decrease) defined as births minus deaths.")

publish_plot(local_change_plot)

```
Population projects show that Bedford County will continue to grow at a substantial rate over the next 30 years. Appomattox and Campbell will see slight growth, while Amherst is slated to see more population decline in the coming decades.

```{r}
#| label: fig-localproj
#| fig-cap: "Projected total population by county"

projections <- read_csv("data/uva_proj.csv") |> 
  subset(FIPS %in% cnty) |> 
  select(NAME, `2030`, `2040`, `2050`) |> 
  pivot_longer(2:4,
               names_to = "year",
               values_to = "value") |> 
  mutate(counttype = "Projection")|> 
  select(NAME, year, counttype, value)

pop_data <- read_rds("data/pop_data.rds") |> 
  subset(GEOID %in% cnty) |> 
  left_join(cv_names, by = "GEOID") |> 
  select(NAME = county, year, counttype, value) |> 
  filter(year == 2020) |> 
  mutate(NAME = paste(NAME, "County", sep = " "))
  
pop_proj <- rbind(projections, pop_data)

local_proj_plot <- ggplot(pop_proj,
       aes(x = year,
           y = value,
           fill = NAME,
           data_id = value,
           tooltip = label_number(big.mark = ",")(value))) +
  geom_col() +
  geom_col_interactive() +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  facet_wrap(~NAME, nrow = 1) +
  labs(title = "Projected total population by county",
       subtitle = "2030, 2040, and 2050 projections",
       caption = "**Source:** U.S. Census Bureau, Decennial Census and University of Virginia, Weldon Cooper Center for Public Service.") +
  scale_y_continuous(labels = label_comma())

publish_plot(local_proj_plot)
  
```

## Household trends

The counties are seeing varying changes among homeowner and renter households. Bedford has seen a major increase in homeowners throughout much of the last decade. As of 2021, there were 2,264 more homeowners in Bedford than in 2010.

Appomattox's growth has been mainly among homeowner households, while renters have declined overall. For Amherst, there has been similar declines in both renters and homeowners. 

Meanwhile, Campbell County has seen the greatest increases in renters among the counties. From 2010 to 2021, there was an increase of 650 renter households and a decrease of 412 homeowners in Campbell.

```{r}
#| label: fig-localtenure
#| fig-cap: "Cumulative change in households by tenure"

b25003_data <- read_rds("data/b25003_data.rds") |> 
  filter(NAME != "Lynchburg city")

local_tenure <- b25003_data |>
  select(county = NAME, year, tenure, estimate) |> 
  group_by(county, year, tenure) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, tenure) |> 
  mutate(diff = estimate - lag(estimate),
         diff = replace_na(diff, 0)) |> 
  mutate(run_diff = cumsum(diff)) |>  
  filter(run_diff != 0)

local_tenure_plot <- ggplot(local_tenure,
       aes(x = year,
           y = run_diff,
           fill = tenure,
           data_id = run_diff,
           tooltip = label_number(big.mark = ",", style_positive = "plus",
                                  style_negative = "minus")(run_diff))) +
  geom_col(position = "dodge") +
  geom_col_interactive(position = "dodge") +
  facet_grid(rows = vars(tenure), cols = vars(county)) +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  scale_x_continuous(breaks = c(2011, 2014, 2017, 2020)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.2, size = 8)) +
  labs(title = "Cumulative change in households by tenure",
       subtitle = "From 2010 to 2021",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B25003.")

publish_plot(local_tenure_plot)

```

The loss of younger households is common among the counties. The percentage of both renter and homeowner householders 45 years old or less have been declining since 2010. But older renters (45 years old and older) have been coming into the counties. Appomattox, in particular, saw an 81 percent increase in renters aged 45 to 64 years old between 2010 and 2021, while Bedford experienced a 56 percent increase in renters 65 years old and over. The growth in homeowners was predominantly among householders aged 65 years and over, where all countied experienced an over 25 percent increase since 2010.

```{r}
#| label: fig-localage
#| fig-cap: "Percent change in households by age and tenure"

b25007_data <- read_rds("data/b25007_data.rds") |> 
  filter(NAME != "Lynchburg city")
  
local_age <- b25007_data |> 
  group_by(county = NAME, year, tenure, age) |> 
  summarise(estimate = sum(estimate)) |> 
  filter(year == 2010 | year == 2021) |> 
  group_by(county, tenure, age) |> 
  mutate(pchg = (estimate - first(estimate))/first(estimate)) |> 
  filter(year == 2021) |> 
  mutate(county = str_remove_all(county, " County"))
  
  # group_by(county, year, tenure) |> 
  # mutate(pct = estimate/sum(estimate))  |> 
  # group_by(county, tenure, age) |> 
  # mutate(diff = estimate - lag(estimate),
  #        diff = replace_na(diff, 0)) |> 
  # mutate(run_diff = cumsum(diff)) |>  
  # filter(run_diff != 0) |> 
  # filter(year == 2021) |> 
  # mutate(year = as.character(year))

local_age_plot <- ggplot(local_age,
       aes(x = county, 
           y = pchg,
           fill = tenure,
           data_id = pchg,
           tooltip = label_percent()(pchg)))  +
  geom_col(position = "dodge") +
  facet_wrap(~age, nrow = 1) +
  geom_col_interactive(position = "dodge", size = 2) +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  scale_y_continuous(labels = label_percent()) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, size = 8),
        legend.position = "bottom",
        legend.text = element_text(size = 8)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  labs(title = "Percent change in households by age and tenure",
       subtitle = "From 2010 to 2021",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B25007.")

publish_plot(local_age_plot)

```

```{r}
#| label: type
#| eval: false

b11001_data <- read_rds("data/b11001_data.rds") |> 
  filter(NAME != "Lynchburg city")

```

Although younger householders are declining in the counties, smaller households are increasing. One-person homeowners households are increasing in Amherst, Appomattox, and Bedford. Unlike its neighbors, Campbell is seeing an increase in *both* one-person renter and homeowner households. Two-person households are overwhelmingly increasing in Bedford.

The counties that did see an increase in larger households were Amherst, Bedford, and Campbell. These increases were mainly among renter households, but Bedford saw an increase of four-person households for both homeowners and renters. 

```{r}
#| label: fig-localsize
#| fig-cap: "Change in households by size and tenure"

b25009_data <- read_rds("data/b25009_data.rds") |> 
  filter(NAME != "Lynchburg city")

local_size <- b25009_data |> 
  select(county = NAME, year, tenure, size, estimate) |> 
  group_by(county, year, tenure, size) |> 
  summarise(estimate = sum(estimate))  |>
  group_by(county, tenure, size) |> 
  mutate(diff = estimate - lag(estimate),
         diff = replace_na(diff, 0)) |> 
  mutate(run_diff = cumsum(diff)) |>  
  filter(run_diff != 0) |> 
  mutate(year = as.character(year)) |> 
  filter(year == "2021") |> 
  mutate(county = str_remove_all(county, " County"))

local_size_plot <- ggplot(local_size,
       aes(x = county,
           y = run_diff,
           fill = tenure,
           data_id = run_diff,
           tooltip )) +
  geom_col(position = "dodge") +
  geom_col_interactive(position = "dodge") +
  facet_wrap(~size, nrow = 1) +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.2, size = 8),
        legend.position = "bottom") +
  labs(title = "Change in households by size and tenure",
       subtitle = "From 2010 to 2021",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B25009.") + 
  scale_y_continuous(labels = label_number(big.mark = ",", style_positive = "plus"))

publish_plot(local_size_plot)

```

The increases in smaller households may be accounted for by increases in the senior (65 years and over) population. But increasing number of seniors living alone can be of great concern for localities. Although many seniors desire to maintain their independence, professionals note that [older adults who live alone are more likely to be poor.](https://www.merckmanuals.com/professional/geriatrics/social-issues-in-older-adults/older-adults-living-alone) Campbell had the largest increase in seniors living alone from 2012 to 2021 (+1,241), followed by Bedford at an addition of 919 seniors living alone.

```{r}
#| label: fig-localsenior
#| fig-cap: "Change in senior population living alone"

b09020_data <- read_rds("data/b09020_data.rds") |> 
  filter(NAME != "Lynchburg city")

local_senior <- b09020_data |> 
  select(county = NAME, year, family, relationship, estimate) |> 
  group_by(county, year, family, relationship) |> 
  summarise(estimate = sum(estimate)) |> 
  pivot_wider(names_from = year,
              values_from = estimate) |> 
  transform(change = `2021` - `2012`) |> 
  select(county, family, relationship, change) |> 
  mutate(family = str_replace(family, "Group quarters", " "),
         family = fct_relevel(family, "Family", "Nonfamily", " ")) |> 
  filter(relationship == "Living alone")

local_senior_plot <- ggplot(local_senior,
                            aes(x = county,
                                y = change,
                                fill = county,
                                data_id = change,
                                tooltip = label_number(big.mark = ",", style_positive = "plus", style_negative = "minus")(change))) +
  geom_col(position = "dodge") +
  geom_col_interactive() +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  scale_y_continuous(labels = label_number(big.mark = ",", style_positive = "plus", style_negative = "minus")) + 
   scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  labs(title = "Change in senior population living alone",
       subtitle = "From 2012 to 2021",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B09020.")

publish_plot(local_senior_plot)

```

Rising costs in the region can force families to double up with others. This creates *subfamilies*, which the Census Bureau [defines](https://www.census.gov/glossary/?term=Subfamily) as:

>A married couple (with or without children) or an unmarried parent with one or more never-married children under the age of 18, residing with the householder, but not including the householder's spouse.
>
>When grown children move back to the parental home with their own children under 18 or a spouse, they are considered a subfamily.

Single parents with children are the most common subfamily type that is experiencing this living situation. But over the last decade, there has been an increasing number of single parents with children living with others in Amherst County. Married couples with and without children are more likely to be in Amherst or Campbell, and their numbers have also been increasing in the last decade.

```{r}
#| label: fig-localsubfam
#| fig-cap: "Change in sufamilies living with others"

b11013_data <- read_rds("data/b11013_data.rds") |> 
  filter(NAME != "Lynchburg city")

local_sub <- b11013_data |> 
  select(county = NAME, year, subfamily, children, estimate) |> 
  mutate(subfamily = case_when(
    subfamily == "Single father" ~ "Single parent",
    subfamily == "Single mother" ~ "Single parent",
    TRUE ~ subfamily
  )) |> 
  group_by(county, year, subfamily, children) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, subfamily, children) |> 
  mutate(diff = estimate - lag(estimate),
         diff = replace_na(diff, 0)) |> 
  mutate(run_diff = cumsum(diff)) |>  
  filter(run_diff != 0) |> 
  filter(year == 2021) 

local_sub_plot <- ggplot(local_sub,
                         aes(x = county,
                             y = run_diff,
                             fill = county,
                             data_id = run_diff,
                             tooltip = label_number(big.mark = ",", style_positive = "plus", style_negative = "minus")(run_diff))) +
  geom_col(position = "dodge") +
  geom_col_interactive() +
  facet_wrap(children~subfamily) +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  scale_y_continuous(labels = label_number(big.mark = ",", style_positive = "plus", style_negative = "minus")) +
  theme(legend.position = "right",
        axis.text.x = element_blank()) +
  labs(title = "Change in subfamilies living with others",
       subtitle = "From 2010 to 2021",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B11013.")

publish_plot(local_sub_plot)

```

Adult children living parents can also be an indicator of affordability challenges. Campbell has consistently seen a decrease in the number of adult children living with parents since 2015, an overall decrease of 511 adults between the age of 18 and 34. Although Amherst and Bedford experienced relatively major increases by 2020, changes in the population led to an overall minimal increase (+75) for Amherst and a decrease for Bedford (-37). Appomattox saw the largest increase in adult children living with parents compared to 2015 estimates (+151).

```{r}
#| label: fig-localachild
#| fig-cap: "Local cumulative change in adult children living with parents"

b09021_data <- read_rds("data/b09021_data.rds") |> 
  filter(NAME != "Lynchburg city")

local_achild <- b09021_data |> 
  select(county = NAME, year, arrangement, estimate) |> 
  filter(arrangement == "Child of householder") |> 
  group_by(county, arrangement) |> 
  mutate(diff = estimate - lag(estimate),
         diff = replace_na(diff, 0)) |> 
  mutate(run_diff = cumsum(diff)) |>  
  filter(run_diff != 0) |> 
  mutate(county = str_remove_all(county, " County"),
         year = as.character(year))

local_achild_plot <- ggplot(local_achild,
                            aes(x = year,
                                y = run_diff,
                                fill = county,
                                data_id = run_diff,
                                tooltip = label_number(big.mark = ",", style_negative = "minus", style_positive = "plus")(run_diff))) +
  geom_col(position = "dodge") +
  geom_col_interactive(size = 1) +
  scale_y_continuous(labels = label_number(big.mark = ",", style_positive = "plus", style_negative = "minus")) +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  facet_wrap(~county, nrow = 1) +
  labs(title = "Cumulative change in young adult children living with parents",
       subtitle = "All adults aged 18-34 from 2015 to 2021",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B09021.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

publish_plot(local_achild_plot)

```

## Economic trends

Across the four counties, renter household incomes skew towards the lower end when compared to their homeowner counterparts, and most lower-income renter households are located in Bedford or Campbell. Homeowner households are more likely to make \$75,000 or more, especially in Bedford.

```{r}
#| label: fig-localinc-distribution
#| fig-cap: "Households by income and tenure"

b25118_data <- read_rds("data/b25118_data.rds") |> 
  filter(NAME != "Lynchburg city")

local_dist <- b25118_data |> 
  select(county = NAME, year, tenure, income, estimate) |> 
  group_by(county, year, tenure, income) |> 
  summarise(estimate = sum(estimate)) |> 
  filter(year == 2021)

level_order <- c("Less than $15,000", "$15,000 to $24,999", "$25,000 to $49,999", "$50,000 to $74,999", "$75,000 to $99,999", "$100,000 to $149,999", "$150,000 or more")

local_dist_plot <- ggplot(local_dist,
       aes(x = factor(income, level = level_order),
           y = estimate,
           fill = tenure,
           data_id = estimate,
           tooltip = label_comma()(estimate))) +
  geom_col(position = "dodge") +
  geom_col_interactive(size = 1, position = "dodge") +
  facet_grid(~county) +
  scale_fill_hfv() +
  theme_hfv() +
  add_zero_line("y") +
  theme(axis.text.x = element_text(angle = 90, vjust = .2, size = 8),
        legend.position = "bottom") +
  scale_y_continuous(labels = label_comma()) +
  labs(title = "Households by income and tenure",
       subtitle = "Number of homeowner and renter households",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 2017-2021 5-year estimates, Table B25118.")

publish_plot(local_dist_plot)

```

Median household income shows that the typical renter income has continued to lag behind homeowners. The income gap between renters and homeowners has only widened in Amherst County and Bedford, while it has narrowed in Appomattox and Campbell. The latter has largely occurred due to the decrease in incomes for homeowners and rises in renter incomes, while the former is the result of diverging incomes. 

```{r}
#| label: fig-med-inc
#| fig-cap: "Median household income by tenure"

b25119_data <- read_rds("data/b25119_cpi.rds") |> 
  filter(NAME != "Lynchburg city, Virginia")

local_inc <- b25119_data |> 
  select(county = NAME, year, tenure, dollars21, cdollars) |> 
  mutate(county = str_remove_all(county, ", Virginia")) |> 
  filter(county != "Bedford city")

local_inc_plot <- ggplot(local_inc,
                         aes(x = year,
                             y = dollars21,
                             color= tenure)) +
  geom_line() +
  geom_point_interactive(
    aes(data_id = dollars21,
        tooltip = label_dollar()(dollars21)),
    size = 1) +
  facet_wrap(~county, nrow = 1) +
  theme_hfv() +
  scale_color_hfv() +
  scale_y_continuous(labels = label_dollar()) +
  labs(title = "Median household income by tenure",
       subtitle = "From 2010 to 2021 in 2021 adjusted dollars",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B25119 and Bureau of Labor Statistics, Consumer Price Index Retroactive Series.") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5))

publish_plot(local_inc_plot)

```

The graph below shows the median household incomes of the different racial and ethnic groups for the four counties in 2021. There are varying disparities between groups depending on locality. Hispanic households in Bedford and Appomattox have much higher median incomes than their Hispanic counterparts in Amherst and Campbell. Meanwhile,  Black households have median household incomes grouped towards the low-end of the spectrum, except for in Bedford, where Black median household income is comparable to white household incomes in neighboring localities.

```{r}
#| label: fig-localrace-inc
#| fig-cap: "Median household income by race and ethnicity"

b19013_data <- read_rds("data/b19013_data.rds") |> 
  filter(NAME != "Lynchburg city")

local_rinc <- b19013_data |> 
  select(county = NAME, year, race, cdollars = estimate, dollars21) |> 
  filter(year == 2021) |> 
  drop_na() |> 
  mutate(label = paste(county, "-", race))
  
local_rinc_plot <- ggplot(local_rinc,
       aes(x = reorder_within(race, cdollars, county),
           y = cdollars,
           fill = race,
           data_id = cdollars,
           tooltip = label_dollar()(cdollars))) +
  geom_col(position = "dodge") +
  geom_col_interactive(size = 1) +
  facet_wrap(~county, scales = "free_x") +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  theme(axis.text.x = element_blank(),
        legend.position = "right") +
  scale_x_reordered() +
  scale_y_continuous(labels = label_dollar()) +
  labs(title = "Median household income by race and ethnicity",
       subtitle = "In 2021 inflation-adjusted dollars",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Tables B19013B-I.")

publish_plot(local_rinc_plot)

```

## Housing stock

The counties contribute to 72 percent of the region's total housing stock. The majority of that share consists of single-family homes occupied by homeowners. Among the owner-occupied housing stock in the counties, there is little diversity as the only other type of housing with noticeable amounts is the "Other" category, which includes manufactured homes.

Renter housing stock in the counties is diverse, but still largely made up of single-family homes and manufactured homes. Two to four unit homes, like duplexes and quads, can look like single-family housing and can often be more affordable, but the counties only contribute one percent of this type of housing to the region's total stock.

Bedford and Campbell counties are the two jurisdictions with the largest share of actual multifamily rental units, while Appomattox County has the lowest. Amherst County has the highest share of two to four unit apartment buildings, which make up just over 25 percent of the county's total rental stock.

```{r}
#| label: fig-localstructure
#| fig-cap: "Housing stock by structure type and tenure"

b25127_data <- read_rds("data/b25127_data.rds") 

local_str <- b25127_data |> 
  filter(year == 2021,
         NAME != "Lynchburg city") |>
  select(county = NAME, tenure, structure, estimate) |> 
  group_by(county, tenure, structure) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, tenure) |> 
  mutate(pct = estimate/sum(estimate)) |> 
  mutate(structure = fct_relevel(structure, "Single-family", "2 to 4 units", "5 to 19 units",
                                 "20 or more units", "Other")) |> 
  ungroup()

local_str_plot <- ggplot(local_str,
       aes(x = structure,
           y = pct,
           fill = structure,
           data_id = pct,
           tooltip = label_percent(accuracy = 0.1)(pct))) +
  geom_col(position = "stack") +
  geom_col_interactive() +
  facet_grid(tenure ~ county, switch = "y") +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() + 
  scale_y_continuous(labels = label_percent()) +
  theme(legend.position = "right",
        axis.text.x = element_blank(),
        strip.placement = "outside") + 
  labs(title = "Housing stock by structure type and tenure",
      subtitle = "Percent of occupied housing units by tenure in 2021",
      caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B25127.")

publish_plot(local_str_plot)

# sums <- local_str |> 
#   filter(structure == "2 to 4 units") 
# 
# sum(sums$pct)

```

Manufactured home communities are prevalent among the four counties. Campbell alone has 41 manufactured home communities, most of which are communities of less than 50 homes. Bedford follows at 30 communities, 22 of which are small communities. 

Although many of these communities make up a bulk of rural communities' affordable housing stock, they are often plagued with housing quality issues. This is due to the prevalence of pre-HUD Code mobile homes located in parks. 

```{r}
#| label: mhc
#| eval: false

mhc <- st_read("https://services1.arcgis.com/Hp6G80Pky0om7QvQ/arcgis/rest/services/Mobile_Home_Parks/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson", quiet = TRUE) |> 
  filter(STATE == "VA") |> 
  filter(str_detect(COUNTY, "AMHERST|APPOMATTOX|BEDFORD|CAMPBELL"))

write_rds(mhc, "data/mhc_cnty.rds")

```

```{r}
#| label: fig-mhc-county
#| fig-cap: "Manufactured home communities by size"

mhc <- read_rds("data/mhc_cnty.rds")

cv_mhc <- mhc  |> 
  group_by(COUNTY, SIZE) |> 
  summarise(count = n_distinct(OBJECTID)) |> 
  st_drop_geometry() |> 
  mutate(COUNTY = str_to_sentence(COUNTY),
         SIZE = str_to_sentence(SIZE))

cv_mhc_plot <- ggplot(cv_mhc,
       aes(x = reorder(COUNTY,count),
           y = count,
           fill = SIZE,
           data_id = count,
           tooltip = count)) +
  geom_col(position = "stack") +
  geom_col_interactive() +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  labs(title = "Manfactured home communities by size",
      subtitle = "Number of homes in each community by county",
       caption = "**Source:** U.S. Department of Homeland Security, Homeland Infrastructure Foundation-Level Data (HIFLD).") +
  theme(legend.position = "right")

publish_plot(cv_mhc_plot)

```

Local residential building permits show that the four counties have experienced the Great Recession and subsequent recovery differently. Bedford was on the rise pre-Recession but has struggled to recover to those previous levels, especially throughout the pandemic. But development in Bedford in recent years has focused on multifamily development (5 or more units), where it is undoubtedly centralized in the Town of Bedford.

Campbell was also seeing major growth ahead of the Great Recession but has seen starts and stops throughout the last decade. On the other hand, Amherst and Appomattox have seen little change in their building permit trends over the last two decades.

Regardless of these changes, there is a severe lack of diverse housing being built in the counties. Homes like duplexes are virtually non-existent in the development pipeline.

```{r}
#| label: fig-localbps
#| fig-cap: "New residential building permits by type"

cv_cbps <- read_rds("data/cv_cbps.rds") |> 
  filter(NAMELSAD != "Lynchburg city")

cv_cbps_plot <- ggplot(cv_cbps,
       aes(x = year,
           y = units,
           fill = type,
           data_id = units,
           tooltip = units)) +
  geom_col(position = "stack") +
  geom_col_interactive() +
  facet_wrap(~NAMELSAD) +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  labs(title = "New residential building permits by type",
       subtitle = "Annual permits issued by locality from 2000 through November 2022",
       caption = "**Source:** U.S. Census Bureau, Building Permits Survey (BPS).") +
  theme(legend.position = "right")

publish_plot(cv_cbps_plot)

```

## Homeownership market

Homeownership rates vary across the four localities. Bedford has the highest homeownership rate at 84 percent, while Campbell has the lowest at 73 percent. Appomattox and Campbell were initially seeing rising homeownership rates throughout the first half of the decade, but those gains began to turn to losses in the second half. For Amherst, decreasing homeownership is a recent trend from 2020 to 2021 and it is uncertain whether this will continue.

Bedford's homeownership rate was affected by the reversion of the city to town status, but in recent years, homeownership has been rising dramatically.

```{r}
#| label: fig-localho
#| fig-cap: "Homeownership rate"

b25003_data <- read_rds("data/b25003_data.rds") |> 
  filter(NAME != "Lynchburg city") |> 
  group_by(NAME, year, tenure) |> 
  summarise(estimate = sum(estimate))

local_ho <- b25003_data |> 
  group_by(NAME, year) |> 
  mutate(pct = estimate/sum(estimate)) |>  
  filter(tenure == "Homeowner") # Retain only homeowners to get the homeownership rate.

local_ho_plot <- ggplot(local_ho,
       aes(x = year, 
           y = pct,
           group = 1,
           color = NAME)) +
  geom_line(size = 0.5) +
  geom_point_interactive(
    aes(data_id = pct,
        tooltip = label_percent()(pct)),
    size = 1) +
  theme_hfv() +
  scale_color_hfv() +
  facet_wrap(~NAME, nrow = 1) +
  scale_y_continuous(limits = c(0.71, 0.85),
                     breaks = seq(from = 0.70, to = 0.86, by = 0.02 ), labels = label_percent()) +
  scale_x_continuous(breaks = seq(from = 2010, to = 2021, by = 2)) +
  labs(title = "Homeownership rate",
       subtitle = "From 2010 to 2021",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B25003.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

publish_plot(local_ho_plot)

```

:::{.callout-note}

TO ADD LATER: sales prices, closings, and days on market by locality -- pending new data from LAR

:::

```{r}
#| label: fig-sales-price

# Need median sales price for each county. Will need to adjust for inflation utilizing the methods found in Lynchburg section.



```

```{r}
#| label: fig-closed-sales

# Need number of closed sales for each county. Make a bar chart for each. See Lynchburg section for stylization.




```

```{r}
#| label: fig-dom

# Need average days on market for each county. Make a bar chart for each. See Lynchburg section for stylization.



```

## Rental market

From 2016 to 2020, rental housing costs in the counties have remained relatively flat (relative to inflation). Since then, rents increased significantly in Bedford and Campbell counties. This growth coincided with rising inflation, so increases have not been significant in constant dollars. However, that adjustment does not account for the much more limited increases in renter incomes in recent years.

:::{.callout-note}

The CoStar data used for this section does not have complete coverage of smaller scale rental properties, such as single-family homes and duplexes. Average rents are primarily sourced from larger, professionally managed apartment communities.

As a result, the sample sizes for Amherst and Appomattox counties---whose rental stock is more significantly comprised of small scale units---are small. Data for these localities should be viewed with caution.

TO ADD LATER: Single-family rent estimates from ACS by county

:::

```{r}
#| label: fig-localrent
#| fig-cap: "Average market asking rent by quarter"

# Utilize CoStar properties search for Multi-Family. Filter by County for Lynchburg - VA Market. Then review Analytics and pull QUARTERLY Market Asking Rent Per Unit for entire region. Do not bring in Forecast and set History to All. Combine Bedford City and Bedford County.

# Download data for current rent and inflation-adjusted rent into a single csv - name [locality_abbv]_rent.csv --- for example amherst_rent.csv or lburg_rent.csv

# Merge all data into a single csv named - local_rent.csv

# Note the download date of data here: 1/23/2023

# lburg_rent <- read_csv("data/lburg_rent.csv") |> 
#  mutate(county = "Lynchburg city")

amherst_rent <- read_csv("data/amherst_rent.csv") |> 
  mutate(county = "Amherst County")

appomattox_rent <- read_csv("data/appomattox_rent.csv") |> 
  mutate(county = "Appomattox County")

bedford_rent <- read_csv("data/bedford_rent.csv") |> 
  mutate(county = "Bedford County")

campbell_rent <- read_csv("data/campbell_rent.csv") |> 
  mutate(county = "Campbell County")

library(zoo)
library(lubridate)

local_rent <- rbind(amherst_rent, appomattox_rent, bedford_rent, campbell_rent) |> 
  filter(!str_detect(period, "QTD")) |> 
  mutate(period = as.Date(as.yearqtr(period, format = "%Y Q%q"), frac = 1)) |> 
  select(county, period, current, inf) |> 
  pivot_longer(3:4,
               names_to = "value",
               values_to = "rent") |> 
  mutate(value = case_when(
    value == "current" ~ "Current dollars",
    value == "inf" ~ "Constant 2022 dollars"
  )) |> 
  #filter(value == "Inflation-adjusted dollars") |> 
  mutate(year = year(period)) |> 
  filter(year >= 2016) |> 
  mutate(rent_label = dollar(rent)) |> 
  mutate(tooltip = c(paste0("Date: ", period, "\n Rent: ", rent_label)))

local_rent_plot <- ggplot(local_rent,
       aes(x = period,
           y = rent,
           linetype = value,
           #group = value,
           color = value)) +
  geom_line() + 
  geom_point_interactive(
    aes(data_id = tooltip,
        tooltip = tooltip),
    size = 0.5) +
  facet_wrap(~county, nrow = 1) +
  scale_linetype_manual(values = c("dotted", "solid")) +
  scale_y_continuous(labels = label_dollar(),
                     limits = c(525,1350),
                     breaks = seq(from = 500, to = 1300, by = 100)) +
  theme_hfv() +
  scale_color_hfv() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "bottom") +
  labs(title = "Average market asking rent by quarter",
       subtitle = "All multifamily properties by locality",
       caption = "**Source:** CoStar Group, Inc.")

publish_plot(local_rent_plot)

```

:::{.callout-note}

TO ADD LATER: Rental vacancy rates by locality

:::


```{r}
#| label: vacancy

# Utilize CoStar properties search for Multi-Family. Filter by County for Lynchburg - VA Market. Then review Analytics and pull QUARTERLY Vacancy Rate for entire region. Do not bring in Forecast and set History to All.

# Download data into csv - name [locality_abbv]_vacancy.csv --- for example amherst_vacancy.csv or lburg_vacancy.csv

# Note the download date of data here: 




```

Rental housing supported by federal subsidy in the counties is most likely to be found in Bedford, no doubt a result of the former City of Bedford's inclusion in the data. Most of the subsidized housing in the counties is made up of project-based Section 8 rental housing (306 units, most of which resides in Bedford). The second most common subsidized housing is the Low-Income Housing Tax Credit (LIHTC) (282 units), then followed by the Rental Housing Section 515 Program administered by the U.S. Department of Agriculture (USDA) (266 units). 

:::{.callout-note}

For more information about these federal housing programs, please visit the [National Housing Preservation Database's Program Descriptions page.](https://preservationdatabase.org/documentation/program-descriptions/)

:::

Campbell is not represented among federal housing programs, but it is important to note that these estimates on affordable housing do not include tenant-based assistance like Housing Choice Vouchers (HCVs) or state-funded programs.

```{r}
#| label: fig-nhpd
#| fig-cap: "Federally-assisted rental homes"

nhpd_subsidies <- read_csv("data/nhpd_subsidies.csv") |> 
  clean_names() |> 
  filter(subsidy_status != "Inactive") |> 
  filter(grepl("amherst", city, ignore.case = TRUE) |
           grepl("bedford", city, ignore.case = TRUE) |
           grepl("campbell", city, ignore.case = TRUE) |
           grepl("appomattox", city, ignore.case = TRUE)) |> 
  select(subsidy_name, subsidy_subname, end_date, units = assisted_units, property_name, owner_type, target_population, city, longitude, latitude) |> 
  mutate(city = str_to_title(city))

cnty_nhpd <- nhpd_subsidies |> 
  group_by(city, subsidy_name) |> 
  summarise(units = sum(units))

cnty_nhpd_plot <- ggplot(cnty_nhpd,
       aes(x = city, 
           y = units,
           fill = subsidy_name,
           data_id = units,
           tooltip = units)) +
  geom_col(position = "stack") +
  geom_col_interactive() +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  labs(title = "Federally-assisted rental homes",
       subtitle = "Number of rental homes with active assistance by primary subsidy program",
       caption = "**Source:** National Housing Preservation Database (NHPD).") +
  theme(legend.position = "right")

publish_plot(cnty_nhpd_plot)

```

Housing Choice Vouchers allow low-income individuals and families to find housing in the private market. HCVs serve as rental assistance to help households pay for housing that may exceed the value of the voucher. HCVs can also be project-based vouchers, meaning that a housing authority can re-allocate funding to tie a tenant-based voucher to a specific housing development.

In the counties, there are 248 HCVs being used by low-income households. Forty-two percent of those vouchers are being utilized in Campbell County.

```{r}
#| label: fig-hcv-map
#| fig-cap: "Households with Housing Choice Vouchers"

hcv <- read_rds("data/hcv.rds") %>% 
  st_transform(crs = 4326) %>% 
  clean_names() %>%
  subset(county %in% cnty_code)

hcv_group <- hcv |> 
  drop_na(hcv_public) |> 
  group_by(county) |> 
  summarise(estimate = sum(hcv_public)) |> 
  mutate(county_name = case_when(
    county == "009" ~ "Amherst County",
    county == "011" ~ "Appomattox County", 
    county == "031" ~ "Campbell County",
    county == "019" ~ "Bedford County"
  )) |> 
  st_drop_geometry()
  
hcv_grp_plot <- ggplot(hcv_group,
       aes(x = county_name,
           y = estimate,
           fill = county_name)) +
  geom_col() +
  geom_col_interactive() +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  labs(title = "Households with Housing Choice Vouchers",
       subtitle = "Number of renters using HCVs in private rental homes",
       caption = "**Source:** U.S. Department of Housing and Urban Development.")

publish_plot(hcv_grp_plot)

# library(mapview)
# 
# mapview(hcv, zcol = "hcv_pct_renter_occ_units")

# palette <- colorNumeric(palette = "viridis", domain = hcv$hcv_pct_renter_occ_units, na.color = "transparent")
# 
# leaflet(hcv) %>% 
#   addTiles() %>% 
#   addPolygons(fillColor = ~palette(hcv_pct_renter_occ_units),
#               fillOpacity = 1)

```

## Affordability

Locally, trends in cost burden follow regional patterns of decreasing cost burden as a whole. But while cost burden for homeowners have been decreasing in each of the counties, renter cost burden has remained relatively unchanged over the last decade.

```{r}
#| label: fig-local-cb
#| fig-cap: "Cost-burdened households by tenure"

cv_cb <- read_rds("data/b25106_data.rds") |> 
  filter(NAME != "Lynchburg city")

local_cb <- cv_cb |> 
  group_by(NAME, year, tenure, cb) |> 
  summarise(estimate = sum(estimate)) |> 
  filter(cb == "Cost-burdened") |> 
  mutate(year_label = as.character(year))

cv_cb_plot <- ggplot(local_cb,
       aes(x = year_label,
           y = estimate,
           fill = tenure,
           data_id = estimate,
           tooltip = label_number(big.mark = ",")(estimate))) +
  geom_col() +
  geom_col_interactive() +
  facet_grid(tenure ~ NAME, switch = "y") +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  scale_y_continuous(labels = label_number(big.mark = ",")) + 
  labs(title = "Cost-burdened households by tenure",
       subtitle = "From 2010 to 2021",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, 5-year estimates, Table B25106.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        strip.placement = "outside")

publish_plot(cv_cb_plot)

```

```{r}
#| label: fig-cb-tenure
#| eval: false
#| fig-cap: "Local cost burden by tenure"

cb_tenure <- read_rds("data/cb_7.rds") |> 
  subset(fips %in% cnty) |> 
  filter(cb_group == "Cost-burdened") |> 
  group_by(year, county, tenure, cb_group) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, tenure) |> 
  mutate(change = estimate - lag(estimate)) |> 
  drop_na() |> 
  mutate(run_diff = cumsum(change))

cb_diff <- ggplot(cb_tenure,
       aes(x = year, 
           y = run_diff, 
           fill = tenure,
           data_id = run_diff,
           tooltip = run_diff)) +
  geom_col(position = "dodge") +
  geom_col_interactive(position = "dodge", size = 2) +
  theme_hfv() +
  scale_fill_hfv() +
  facet_wrap(~county, nrow = 1) +
  scale_y_continuous(labels = label_comma()) +
  labs(title = "Cumulative change in cost-burdened households by tenure",
       subtitle = "2012 to 2019",
       fill = "Tenure",
       caption = "**Source:** U.S Department of Housing and Urban Development,<br>Comprehensive Housing Affordability Strategy (CHAS), Table 7.") +
  theme(legend.position = "right") +
  add_zero_line(axis = "y")


if (knitr::is_html_output()) {
  
  girafe(ggobj = cb_diff,
         height_svg = 4) 
  
} else {
  
  cb_diff
  
  }
  

```

Cost burden by race and ethnicity shows that white households across all four counties are less likely to be cost-burdened. This has been consistent since 2012. 

:::{.callout-caution}

Need to address margins of error on the estimates for Asian, another race, and Hispanic households. It may be best to exclude them from this.

:::

```{r}
#| label: fig-cb-race
#| fig-cap: "Cost burden by race and ethnicity"

cb_9 <- read_rds("data/cb_9.rds")

cv_cb9 <- cb_9 |> 
  subset(fips %in% cnty) |> 
  group_by(year, county, race, cb_group) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(year, county, race) |> 
  mutate(pct = estimate/sum(estimate)) |> 
  filter(cb_group == "Cost-burdened") |> 
  filter(year == 2019)

cv_cb9_plot <- ggplot(cv_cb9,
       aes(x = reorder_within(county, pct, race),  
           y = pct,
           fill = str_wrap(race, width = 10),
           data_id = pct,
           tooltip = label_percent()(pct))) +
  facet_wrap(~county, nrow = 1, scales = "free_x") +
  geom_col() +
  geom_col_interactive(size = 1) +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  theme(axis.text.x = element_blank(),
        legend.position = "right",
        #legend.text = element_text(lineheight = .8),
        legend.key.height = unit(2, "lines")) +
  scale_x_reordered() +
  scale_y_continuous(labels = label_percent()) +
  labs(title = "Cost burden by race and ethnicity",
       subtitle = "Percent of households with cost burden by race and ethnicity in 2019",
       caption = "**Source:** U.S. Department of Housing and Urban Development, Comprehensive Housing Affordability Strategy (CHAS), Table 9.")

publish_plot(cv_cb9_plot)

```

```{r}
#| label: fig-cb-total
#| eval: false
#| fig-cap: "Local housing cost burden by household area median income"

cb_7 <- read_rds("data/cb_7.rds") |> 
  filter(county != "Lynchburg city")
  
cbhh_region <- cb_7 |> 
  group_by(county, year, household_income, cb_group) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, year, household_income) |> 
  mutate(pct = estimate/sum(estimate)) |> 
  filter(cb_group == "Cost-burdened") |> 
  filter(year == 2019)

cbhh_region$household_income <- factor(cbhh_region$household_income,
                                       levels = c("30% AMI or less", "31 to 50% AMI", "51 to 80% AMI", "81 to 100% AMI", "101% AMI or greater"))

cbhh_region_plot <- ggplot(cbhh_region,
       aes(x = household_income, 
           y = pct, 
           fill = household_income,
           data_id = pct,
           tooltip = label_percent()(pct))) +
  geom_col(position = "dodge") +
  geom_col_interactive(position = "dodge", size = 2) +
  theme_hfv() +
  scale_fill_hfv() +
  facet_wrap(~county, nrow = 1, labeller = label_wrap_gen(10)) +
  scale_y_continuous(labels = label_percent()) +
  scale_x_reordered() +
  labs(title = "Local cost burden by household area median income",
       subtitle = "Percent of cost-burdened households by household income in 2019",
       caption = "**Source:** U.S Department of Housing and Urban Development,<br>Comprehensive Housing Affordability Strategy (CHAS), Table 7.") +
  add_zero_line(axis = "y") +
  theme(axis.text.x = element_blank(),
        legend.position = "right",
        strip.text = element_text(size = 8))


if (knitr::is_html_output()) {
  
  girafe(ggobj = cbhh_region_plot,
         height_svg = 4) 
  
} else {
  
  cbhh_region_plot
  
  }

```

In Amherst and Bedford, non-elderly, non-family households (i.e. individuals living alone or with unrelated persons) are more likely to be cost-burdened than any other household type, 44 and 30 percent cost-burdened, respectively. Meanwhile, in Appomattox and Campbell, 29 percent of elderly, non-family households (i.e. seniors living alone or with unrelated persons) were cost-burdened in 2019. These two household types face the most difficult challenges in affordability, most likely due to the challenges of affording housing alone. But interestingly, just over one in four (26 percent) large families in Appomattox are cost-burdened, a divergence from trends in the other three counties. 

```{r}
#| label: fig-hh-cb
#| fig-cap: "Cost burden by household type"

cb_7 <- read_rds("data/cb_7.rds") |> 
  filter(county != "Lynchburg city")
  
cbhh_region <- cb_7 |> 
  group_by(county, year, household_type, cb_group) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, year, household_type) |> 
  mutate(pct = estimate/sum(estimate)) |> 
  filter(cb_group == "Cost-burdened") |> 
  filter(year == 2019)

cb_hh_plot <- ggplot(cbhh_region,
       aes(x = reorder(household_type, pct),
           y = pct,
           fill = household_type,
           data_id = pct,
           tooltip = label_percent()(pct))) +
  geom_col() +
  geom_col_interactive() +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  theme(axis.text.x = element_blank(),
        strip.text = element_text(size = 8),
        legend.position = "right") +
    facet_wrap(~county, nrow = 1, labeller = label_wrap_gen(10)) +
  scale_y_continuous(labels = label_percent()) +
  labs(title = "Cost burden by household type",
       subtitle = "Percent of households with cost burden by household type in 2019",
       caption = "**Source:** U.S. Department of Housing and Urban Development, Comprehensive Housing Affordability Strategy (CHAS), Table 7.")

publish_plot(cb_hh_plot)

```

The chart below shows whether renter households are currently living in affordable or unaffordable apartments, broken down by Area Median Income by to 80 percent AMI. For example, among all renters at or below 30 percent AMI in Amherst County, 365 are able to afford their current home, while another 410 cannot.

This represents a rental housing "gap" of more than 400 homes that must be created or made affordable to alleviate cost burden among those renters. Across the region, this gap is most severe for renters below 50 percent AMI. Very few renters between 50 and 80 percent AMI currently struggle to afford their home.

:::{.callout-caution}

As of spring 2023, the latest available CHAS estimates published by HUD are based on the 2015-2019 American Community Survey 5-year estimates. Therefore, these estimates **do not** reflect changes that have occurred since the beginning of the COVID-19 pandemic.

:::

Across all four counties, the rental housing gap below 30 percent AMI is 2070 units, 913 units between 30 and 50 percent AMI, and 135 units between 50 and 80 percent AMI. The total rental housing gap is 3,118.

```{r}
#| label: fig-gap
#| fig-cap: "Rental housing gap by household income"

tb_18_match <- read_rds("data/tb_18_match.rds")

gap <- tb_18_match |> 
  subset(fips %in% cnty) |> 
  group_by(year, county, household_income, gapcode) |> 
  summarise(estimate = sum(estimate)) |> 
  mutate(estimate = case_when(
    gapcode == "Gap" ~ estimate * -1,
    gapcode == "Matches or less than income" ~ estimate
  )) |> 
  filter(household_income != "80 percent AMI or greater") |> 
  mutate(gapcode = case_when(
    gapcode == "Gap" ~ "Unaffordable",
    TRUE ~ "Affordable"
  )) |> 
  filter(year == 2019)

gap_plot <- ggplot(gap,
       aes(x = household_income, 
           y = estimate,
           fill = gapcode,
           data_id = estimate,
           tooltip = label_number(big.mark = ",", style_positive = "plus")(estimate))) +
  geom_col() +
  geom_col_interactive() +
  facet_grid(~county, labeller = label_wrap_gen(10)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  scale_y_continuous(labels = label_comma()) +
  theme_hfv() +
  add_zero_line("y") +
  scale_fill_hfv() +
  labs(title = "Rental housing gap by household income",
       subtitle = "Affordability of existing rental homes by AMI of current occupants (2019)",
       caption = "**Source:** U.S. Department of Housing and Urban Development, Comprehensive Housing Affordability Strategy, Table 18B") +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )

publish_plot(gap_plot)

```
